<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Writing Trainer</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #27ae60;
            --bg: #f4f4f9;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; color: #333; }
        h1 { color: var(--primary); margin-bottom: 10px; }
        
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); max-width: 800px; width: 100%; text-align: center; position: relative; min-height: 500px; }
        
        /* Screens */
        .screen { display: none; animation: fadeIn 0.3s ease-in-out; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Game UI */
        .status-bar { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 20px; padding: 10px; background: #ecf0f1; border-radius: 8px; }
        
        .drop-zone { 
            min-height: 80px;
            border: 2px dashed var(--secondary); 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 20px; 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 10px; 
            background-color: #f8f9fa; 
            align-items: center; 
            transition: background-color 0.3s;
        }

        /* LOCKED STATE */
        .drop-zone.locked {
            border-style: solid;
            border-color: #ddd;
            background-color: #f0f0f0;
            pointer-events: none; /* Disables all clicks and drags inside */
        }
        
        .pieces-pool { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 10px; min-height: 40px; }
        
        .puzzle-piece { 
            background-color: var(--secondary); color: white; padding: 10px 15px; border-radius: 6px; 
            cursor: pointer; user-select: none; transition: transform 0.2s, background 0.2s; font-size: 16px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .puzzle-piece:hover { background-color: #2980b9; transform: translateY(-2px); }
        .puzzle-piece.used { opacity: 0; pointer-events: none; width: 0; padding: 0; margin: 0; overflow: hidden; }
        
        .puzzle-piece.answer-block { background-color: var(--accent); cursor: grab; }
        .puzzle-piece.answer-block:active { cursor: grabbing; }

        /* Visual style for locked pieces */
        .drop-zone.locked .puzzle-piece {
            opacity: 0.8;
            cursor: default;
            box-shadow: none;
        }
        
        /* Dragging visuals */
        .puzzle-piece.dragging { opacity: 0.5; transform: scale(0.95); }

        /* Usage Context Box */
        .context-box { 
            background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 15px; margin: 15px 0; 
            text-align: left; display: none; color: #856404; font-size: 0.95rem;
        }

        /* Buttons */
        .btn { background-color: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 5px; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        
        .btn-large { font-size: 1.2rem; padding: 15px 30px; margin-top: 20px; }
        .btn-secondary { background-color: #95a5a6; }
        .btn-danger { background-color: #e74c3c; }
        .btn-small { padding: 5px 10px; font-size: 12px; }

        /* Feedback */
        .feedback { margin: 15px 0; font-weight: bold; height: 24px; font-size: 18px; }
        .correct { color: var(--accent); }
        .wrong { color: #e74c3c; }

        /* Inputs & Settings */
        .settings-group { margin: 20px 0; text-align: center; display: inline-block; }
        .settings-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="number"] { padding: 10px; border-radius: 5px; border: 1px solid #ddd; width: 100px; font-size: 1.2rem; text-align: center; }
        input[type="text"] { padding: 10px; border-radius: 5px; border: 1px solid #ddd; width: 200px; font-size: 1rem; }

        /* Tables (History & Dictionary) */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .data-table th { background-color: var(--primary); color: white; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; color: white; }
        .badge-success { background: var(--accent); }
        .badge-danger { background: #e74c3c; }

        /* Dictionary Specific */
        .dict-container { max-height: 400px; overflow-y: auto; text-align: left; }
        .dict-sentence { font-weight: bold; color: var(--primary); }
        .dict-context { font-size: 0.9em; color: #666; font-style: italic; margin-top: 4px; }

        /* Result Details */
        .review-item { border-bottom: 1px solid #eee; padding: 10px 0; text-align: left; }
        .review-item strong { display: block; margin-bottom: 4px; }
        .user-ans { color: #e74c3c; text-decoration: line-through; margin-right: 10px; }
        .correct-ans { color: var(--accent); }
    </style>
</head>
<body>

    <h1>IELTS Writing Trainer</h1>
    
    <div class="container">
        
        <!-- 1. Start Screen -->
        <div id="start-screen" class="screen active">
            <h2>Start New Session</h2>
            <p>Assemble the pieces to master formal writing expressions.</p>
            
            <div class="settings-group">
                <label>How many sentences today?</label>
                <input type="number" id="goal-input" value="5" min="1" max="100">
            </div>
            
            <br>
            
            <button class="btn btn-large" onclick="gameManager.startSession()">â–¶ Start Practice</button>
            <br><br>
            <button class="btn btn-secondary" onclick="gameManager.showHistory()">ðŸ“œ View History</button>
            <button class="btn btn-secondary" onclick="gameManager.showDictionary()">ðŸ“– Sentence List</button>
        </div>

        <!-- 2. Game Screen -->
        <div id="game-screen" class="screen">
            <div class="status-bar">
                <span>Progress: <span id="progress-display">1/5</span></span>
                <span>Correct First Tries: <span id="score-display">0</span></span>
            </div>

            <p id="instruction-text">Drag pieces to reorder or click to remove.</p>
            
            <!-- Drop Zone (Answer) -->
            <div id="answer-area" class="drop-zone" ondragover="allowDrop(event)" ondrop="handleDropZone(event)"></div>
            
            <!-- Context/Help Box -->
            <div id="context-box" class="context-box">
                <strong>ðŸ’¡ When to use:</strong> <span id="context-text"></span>
            </div>

            <div id="feedback" class="feedback"></div>

            <!-- Pieces Pool -->
            <div id="pieces-area" class="pieces-pool"></div>
            
            <div id="controls">
                <!-- Previous Button -->
                <button id="btn-prev" class="btn btn-secondary" style="display:none;" onclick="game.prevQuestion()">â¬… Previous</button>
                
                <button id="btn-check" class="btn" onclick="game.checkAnswer()">Check Answer</button>
                <button id="btn-next" class="btn" style="display:none;" onclick="game.nextQuestion()">Next âž¡</button>
                <button class="btn btn-secondary" onclick="gameManager.endSessionEarly()">Quit</button>
            </div>
        </div>

        <!-- 3. Summary Screen -->
        <div id="summary-screen" class="screen">
            <h2 id="summary-title">Session Complete!</h2>
            <h3 id="final-score">Score: 8/10</h3>
            <div id="summary-details" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;"></div>
            <button class="btn" onclick="gameManager.showStartScreen()">Back to Home</button>
            <button class="btn btn-secondary" onclick="gameManager.showHistory()">Check History</button>
        </div>

        <!-- 4. History Screen -->
        <div id="history-screen" class="screen">
            <h2>Practice History</h2>
            <button class="btn btn-danger" onclick="historyManager.clearAll()">Clear All History</button>
            <button class="btn btn-secondary" onclick="gameManager.showStartScreen()">Back to Home</button>
            
            <div style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Score</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="history-list"></tbody>
                </table>
            </div>
        </div>

        <!-- 5. History Detail Screen -->
        <div id="history-detail-screen" class="screen">
            <h2>History Details</h2>
            <div id="history-detail-content" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;"></div>
            <button class="btn btn-secondary" onclick="gameManager.showHistory()">Back to History List</button>
        </div>

        <!-- 6. Dictionary Screen -->
        <div id="dictionary-screen" class="screen">
            <h2>Sentence List</h2>
            <p>Review all available sentences and their usage.</p>
            
            <div style="margin: 20px 0; padding: 15px; background: #ecf0f1; border-radius: 8px;">
                <div style="display:flex; justify-content: center; align-items: center; gap: 10px;">
                    <input type="text" id="custom-input" placeholder="Type new sentence here..." style="width: 60%; padding: 8px;">
                    <button class="btn" style="margin:0;" onclick="game.addCustom()">Add New</button>
                </div>
                <div style="font-size:0.85em; color:#666; margin-top:5px;">(Must be > 5 characters)</div>
            </div>

            <button class="btn btn-secondary" onclick="gameManager.showStartScreen()">Back to Home</button>
            
            <div class="dict-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Sentence & Context</th>
                        </tr>
                    </thead>
                    <tbody id="dictionary-list"></tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Data Import -->
    <script src="ielts_data.js"></script>

    <script>
        // --- AUDIO MANAGER (NEW) ---
        const speechManager = {
            speak: function(text) {
                if (!window.speechSynthesis) return;
                // Cancel any currently playing speech to avoid overlap
                window.speechSynthesis.cancel();
                
                let textToSpeak = text;
                // Fix for "Capital I" reading: Force phonetic pronunciation
                if (text === "I") {
                    textToSpeak = "Eye"; 
                }
                
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                // Attempt to set a British voice for IELTS feel, fallback to default
                utterance.lang = 'en-GB'; 
                utterance.rate = 1; // Normal speed
                
                window.speechSynthesis.speak(utterance);
            }
        };

        // --- Drag and Drop Logic ---
        let dragSrcEl = null;

        function handleDragStart(e) {
            if (this.parentNode.classList.contains('locked')) {
                e.preventDefault();
                return false;
            }
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (dragSrcEl !== this) {
                let container = this.parentNode;
                if (container.classList.contains('locked')) return false;

                let children = Array.from(container.children);
                let srcIndex = children.indexOf(dragSrcEl);
                let targetIndex = children.indexOf(this);
                
                if (srcIndex < targetIndex) {
                    container.insertBefore(dragSrcEl, this.nextSibling);
                } else {
                    container.insertBefore(dragSrcEl, this);
                }
            }
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            game.rebuildSelection();
        }

        function allowDrop(ev) { ev.preventDefault(); }
        function handleDropZone(ev) { ev.preventDefault(); }

        // --- Game Manager (Screens & State) ---
        const gameManager = {
            screens: ['start-screen', 'game-screen', 'summary-screen', 'history-screen', 'history-detail-screen', 'dictionary-screen'],
            
            showScreen: function(id) {
                this.screens.forEach(s => document.getElementById(s).classList.remove('active'));
                document.getElementById(id).classList.add('active');
            },

            showStartScreen: function() { this.showScreen('start-screen'); },
            
            showHistory: function() { 
                historyManager.render();
                this.showScreen('history-screen'); 
            },

            showHistoryDetails: function(index) {
                historyManager.renderDetails(index);
                this.showScreen('history-detail-screen');
            },

            showDictionary: function() {
                const list = document.getElementById('dictionary-list');
                list.innerHTML = '';
                
                const displayData = typeof defaultSentences !== 'undefined' ? defaultSentences : [];

                if(displayData.length === 0) {
                    list.innerHTML = "<tr><td>No sentences found in database.</td></tr>";
                }

                const reversedData = [...displayData].reverse();

                reversedData.forEach(item => {
                    const text = item.text || item;
                    const ctx = item.context || "No context provided.";
                    
                    let tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <div class="dict-sentence">${text}</div>
                            <div class="dict-context">${ctx}</div>
                        </td>`;
                    list.appendChild(tr);
                });

                this.showScreen('dictionary-screen');
            },

            startSession: function() {
                let inputVal = document.getElementById('goal-input').value;
                let goal = parseInt(inputVal);
                if(isNaN(goal) || goal < 1) goal = 5; 
                
                game.init(goal);
                this.showScreen('game-screen');
            },

            endSessionEarly: function() {
                if(confirm("Quit current session? Progress will be lost.")) {
                    this.showStartScreen();
                }
            },

            finishSession: function(results) {
                const correctCount = results.filter(r => r.isCorrect).length;
                const total = results.length;
                
                historyManager.save({
                    date: new Date().toLocaleString(),
                    score: correctCount,
                    total: total,
                    details: results
                });

                document.getElementById('summary-title').innerText = "Session Complete!";
                document.getElementById('final-score').innerText = `Score: ${correctCount}/${total}`;
                
                this.renderResultsList('summary-details', results);
                this.showScreen('summary-screen');
            },

            renderResultsList: function(elementId, results) {
                const detailsDiv = document.getElementById(elementId);
                detailsDiv.innerHTML = '';

                results.forEach((r, index) => {
                    let div = document.createElement('div');
                    div.className = 'review-item';
                    if (r.isCorrect) {
                        div.innerHTML = `<span class="badge badge-success">Correct</span> <strong>${r.target}</strong>`;
                    } else {
                        div.innerHTML = `<span class="badge badge-danger">Wrong</span> 
                                         <span class="user-ans">${r.userAnswer}</span> <br>
                                         <span class="correct-ans">âžœ ${r.target}</span>`;
                    }
                    detailsDiv.appendChild(div);
                });
            }
        };

        // --- Game Logic ---
        const game = {
            sentences: [],
            sessionGoal: 0,
            currentIdx: 0,
            score: 0,
            sessionResults: [],
            sessionFinalStates: [],
            userSelection: [],
            currentTarget: null,
            firstAttemptMade: false,

            init: function(goal) {
                if (typeof defaultSentences === 'undefined') {
                    alert("Data file missing!"); return;
                }
                
                this.sentences = defaultSentences.map(item => {
                    return typeof item === 'string' ? { text: item, context: "Practice common expression." } : item;
                });

                this.sentences.sort(() => Math.random() - 0.5);

                this.sessionGoal = Math.min(goal, this.sentences.length);
                this.currentIdx = 0;
                this.score = 0;
                this.sessionResults = [];
                this.sessionFinalStates = [];
                
                this.renderQuestion(0);
            },

            renderQuestion: function(index) {
                this.currentIdx = index;
                const isReviewing = index < this.sessionResults.length;
                const data = this.sentences[index];
                this.currentTarget = data;

                document.getElementById('progress-display').innerText = `${index + 1}/${this.sessionGoal}`;
                document.getElementById('score-display').innerText = this.score;
                
                const answerArea = document.getElementById('answer-area');
                const piecesArea = document.getElementById('pieces-area');
                const feedback = document.getElementById('feedback');
                const contextBox = document.getElementById('context-box');
                const checkBtn = document.getElementById('btn-check');
                const nextBtn = document.getElementById('btn-next');
                const prevBtn = document.getElementById('btn-prev');

                answerArea.innerHTML = '';
                piecesArea.innerHTML = '';
                feedback.innerText = '';
                contextBox.style.display = 'none';

                answerArea.classList.remove('locked');

                let wordsToRenderInAnswer = [];
                let wordsToRenderInPool = [];

                if (isReviewing) {
                    const finalState = this.sessionFinalStates[index] || this.sentences[index].text.split(" ");
                    wordsToRenderInAnswer = finalState;
                    wordsToRenderInPool = []; 
                    
                    answerArea.classList.add('locked'); 
                    feedback.innerHTML = `<span class="correct">Completed âœ…</span>`;
                    feedback.className = "feedback";
                    document.getElementById('context-text').innerText = data.context || "Standard phrase.";
                    contextBox.style.display = 'block';
                    
                    checkBtn.style.display = 'none';
                    nextBtn.style.display = 'inline-block';
                } 
                else {
                    this.firstAttemptMade = false;
                    this.userSelection = [];
                    
                    let words = data.text.split(" ");
                    wordsToRenderInPool = [...words].sort(() => Math.random() - 0.5);
                    wordsToRenderInAnswer = [];

                    checkBtn.style.display = 'inline-block';
                    checkBtn.disabled = false;
                    nextBtn.style.display = 'none';
                    document.getElementById('instruction-text').innerText = "Drag pieces to reorder or click to remove.";
                }

                wordsToRenderInAnswer.forEach(word => {
                    let block = this.createPiece(word, true);
                    answerArea.appendChild(block);
                    if (!isReviewing) this.userSelection.push(word);
                });

                wordsToRenderInPool.forEach((word, i) => {
                    let piece = this.createPiece(word, false);
                    if(!isReviewing) {
                        piece.onclick = () => this.addToAnswer(word, piece);
                    }
                    piecesArea.appendChild(piece);
                });

                prevBtn.style.display = (index > 0) ? 'inline-block' : 'none';
            },

            createPiece: function(word, isAnswerBlock) {
                let div = document.createElement('div');
                div.innerText = word;
                div.className = isAnswerBlock ? 'puzzle-piece answer-block' : 'puzzle-piece';
                
                if (isAnswerBlock) {
                    div.draggable = true;
                    div.addEventListener('dragstart', handleDragStart);
                    div.addEventListener('dragover', handleDragOver);
                    div.addEventListener('drop', handleDrop);
                    div.addEventListener('dragend', handleDragEnd);
                }
                return div;
            },

            addToAnswer: function(word, sourceEl) {
                if(document.getElementById('answer-area').classList.contains('locked')) return;

                // CLICK TO SPEAK (NEW)
                speechManager.speak(word);

                sourceEl.classList.add('used');
                
                let answerArea = document.getElementById('answer-area');
                let block = this.createPiece(word, true);
                
                block.onclick = () => {
                    if(document.getElementById('answer-area').classList.contains('locked')) return;
                    
                    // CLICK TO SPEAK ON REMOVE (NEW)
                    speechManager.speak(word);

                    block.remove();
                    sourceEl.classList.remove('used');
                    this.rebuildSelection();
                };

                answerArea.appendChild(block);
                this.rebuildSelection();
            },

            rebuildSelection: function() {
                this.userSelection = [];
                let blocks = document.querySelectorAll('#answer-area .answer-block');
                blocks.forEach(b => this.userSelection.push(b.innerText));
            },

            checkAnswer: function() {
                const constructed = this.userSelection.join(" ");
                const target = this.currentTarget.text;
                const isCorrect = constructed === target;
                
                const feedback = document.getElementById('feedback');
                const contextBox = document.getElementById('context-box');
                const answerArea = document.getElementById('answer-area');

                if (!this.firstAttemptMade) {
                    this.firstAttemptMade = true;
                    if (isCorrect) this.score++;
                    this.sessionResults.push({
                        target: target,
                        userAnswer: constructed,
                        isCorrect: isCorrect
                    });
                }

                if (isCorrect) {
                    feedback.innerText = "Correct! âœ…";
                    feedback.className = "feedback correct";
                    
                    // READ FULL SENTENCE (NEW)
                    speechManager.speak(this.currentTarget.text);

                    document.getElementById('context-text').innerText = this.currentTarget.context || "Standard phrase.";
                    contextBox.style.display = 'block';

                    answerArea.classList.add('locked');
                    this.sessionFinalStates.push(this.userSelection);

                    document.getElementById('btn-check').style.display = 'none';
                    document.getElementById('btn-next').style.display = 'inline-block';
                    
                } else {
                    feedback.innerText = "Incorrect. Try again! âŒ";
                    feedback.className = "feedback wrong";
                    contextBox.style.display = 'none';
                    answerArea.classList.remove('locked');
                    document.getElementById('btn-next').style.display = 'none';
                }
            },

            prevQuestion: function() {
                if(this.currentIdx > 0) {
                    this.renderQuestion(this.currentIdx - 1);
                }
            },

            nextQuestion: function() {
                if (this.currentIdx < this.sessionResults.length - 1) {
                    this.renderQuestion(this.currentIdx + 1);
                } else {
                    if (this.sessionResults.length >= this.sessionGoal) {
                        gameManager.finishSession(this.sessionResults);
                    } else {
                        this.renderQuestion(this.sessionResults.length);
                    }
                }
            },

            addCustom: function() {
                const input = document.getElementById('custom-input');
                const val = input.value.trim();
                if(val.length > 5) {
                    const newItem = { text: val, context: "User added sentence." };
                    if(typeof defaultSentences !== 'undefined') {
                        defaultSentences.push(newItem);
                    }
                    this.sentences.push(newItem); 
                    alert("Added to database!");
                    input.value = "";
                    gameManager.showDictionary();
                } else {
                    alert("Sentence must be at least 5 characters long.");
                }
            }
        };

        // --- History Manager ---
        const historyManager = {
            storageKey: 'ielts_game_history',
            
            getHistory: function() {
                const data = localStorage.getItem(this.storageKey);
                return data ? JSON.parse(data) : [];
            },

            save: function(record) {
                const history = this.getHistory();
                history.unshift(record); 
                localStorage.setItem(this.storageKey, JSON.stringify(history));
            },

            clearAll: function() {
                if(confirm("Delete all history?")) {
                    localStorage.removeItem(this.storageKey);
                    this.render();
                }
            },

            deleteItem: function(index) {
                const history = this.getHistory();
                history.splice(index, 1);
                localStorage.setItem(this.storageKey, JSON.stringify(history));
                this.render();
            },

            render: function() {
                const history = this.getHistory();
                const tbody = document.getElementById('history-list');
                tbody.innerHTML = '';

                if (history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3">No history yet.</td></tr>';
                    return;
                }

                history.forEach((h, index) => {
                    let tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${h.date}</td>
                        <td>${h.score}/${h.total}</td>
                        <td>
                            <button class="btn btn-secondary btn-small" onclick="gameManager.showHistoryDetails(${index})">View Details</button>
                            <button class="btn btn-danger btn-small" onclick="historyManager.deleteItem(${index})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            },

            renderDetails: function(index) {
                const history = this.getHistory();
                const record = history[index];
                if (!record) return;
                gameManager.renderResultsList('history-detail-content', record.details);
            }
        };
    </script>
</body>
</html>
